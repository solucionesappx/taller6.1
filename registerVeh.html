<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Órdenes</title>
    <!-- Incluye Tailwind CSS desde CDN para un diseño moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga la fuente Inter de Google Fonts para un diseño limpio -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Incluye la biblioteca de íconos Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Un gris muy suave para el fondo de la página */
        }
        /* Estilos personalizados para la barra de navegación */
        .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0; 
            transition: all 0.2s ease-in-out;
            font-weight: 600;
        }
        /* Oculta los botones de incremento/decremento del input de tipo 'number' */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Estilos para el contenedor del formulario con scroll */
        .scrollable-form-container {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col transition-colors duration-300">

    <!-- Nueva barra de navegación integrada -->
    <nav class="fixed top-0 left-0 w-full bg-gray-100 text-gray-800 shadow-lg z-50">
        <div class="container mx-auto px-4 py-2">
            <ul class="flex justify-around items-center list-none p-0 m-0">
                <li class="flex-1">
                    <button id="homeBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-home text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Inicio</span>
                    </a>
                </li>
                <li class="flex-1">
                    <id="vehiculosBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-car text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Vehículo</span>
                    </a>
                </li>
                <li class="flex-1">
                    <id="ordenesBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-tools text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Servicios</span>
                    </a>
                </li>
                <li class="flex-1">
                    <id="buscarBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-search text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Búsqueda</span>
                    </a>
                </li>
                <li class="flex-1">
                    <id="modificarBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-search text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Modificar</span>
                    </a>
                </li>
                <li class="flex-1">
                    <id="logoutBtn" class="nav-link w-full text-gray-800 border-2 border-transparent hover:bg-gray-200 hover:border-gray-500 hover:rounded-lg">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                        <span class="mt-1 text-xs sm:text-sm">Salir</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>    
    
    <!-- Contenedor principal para el formulario -->
    <main class="flex-grow flex items-center justify-center p-4">
        <div class="bg-gray-200 dark:bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md transition-colors duration-300">
            <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">Formulario de Registro</h2>
            
            <form id="vehicleForm" class="space-y-2">
                <!-- Campo no editable para el ID del vehículo -->
                <div>
                    <label for="vehiculoId" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Vehículo ID</label>
                    <input type="text" id="vehiculoId" name="vehiculoId" readonly class="w-full p-1 rounded-lg bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200 cursor-not-allowed">
                </div>

                <!-- Campo para la marca del vehículo -->
                <div>
                    <label for="marca" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Marca</label>
                    <input type="text" id="marca" name="marca" required placeholder="Ej. Toyota" class="w-full p-1 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200">
                </div>

                <!-- Campo para el modelo del vehículo -->
                <div>
                    <label for="modelo" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Modelo</label>
                    <input type="text" id="modelo" name="modelo" required placeholder="Ej. Corolla" class="w-full p-1 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200">
                </div>
                
                <!-- Campo para el año del vehículo. Se cambió "anio" por "year". -->
                <div>
                    <label for="year" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Año</label>
                    <input type="number" id="year" name="year" required min="1900" max="2100" placeholder="Ej. 2024" class="w-full p-1 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200">
                </div>

                <!-- Campo para la placa del vehículo -->
                <div>
                    <label for="placa" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Placa</label>
                    <input type="text" id="placa" name="placa" required placeholder="Ej. ABC123" class="w-full p-1 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200">
                </div>

                <!-- Nuevo campo para la Persona de Contacto -->
                <div>
                    <label for="contacto" class="block text-gray-700 dark:text-gray-300 font-medium mb-2">Persona Contacto</label>
                    <input type="text" id="contacto" name="contacto" placeholder="Ej. Juan Pérez" class="w-full p-1 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors duration-200">
                </div>
            </form>
            
            <!-- Botón de enviar el formulario fuera del contenedor del formulario con el margen aplicado -->
            <button type="button" id="saveBtn" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                Guardar Vehículo
            </button>
        </div>
    </main>

    <!-- Contenedor de mensajes (alerta modal con animaciones) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center transform transition-transform duration-300 scale-95">
            <p id="messageText" class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4"></p>
            <div id="dataList" class="text-left mb-4 text-gray-700 dark:text-gray-300"></div>
            <!-- Se actualiza el texto del botón -->
            <button onclick="closeMessage()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                Aceptar
            </button>
        </div>
    </div>

    <script>
        // --- URL del Google Apps Script ---
        const GAS_REGISTER_HISTORY_URL = 'https://script.google.com/macros/s/AKfycbz3x4bm5RETRKsqn2w9eJrKTqVUbRQX96ChZFCdyXA8_IdQaTcqrXRpOnF6F_9PzOaYFw/exec';

        // --- FUNCIÓN PARA REGISTRAR EN EL HISTORIAL ---
        /**
         * Registra un evento en la hoja de historial del Google Sheet.
         * @param {string} cliente_id - El ID del cliente.
         * @param {string} nombre - El nombre del cliente.
         * @param {string} action - La acción a registrar (ej. 'Visita a Menú').
         */
        async function registerHistory(cliente_id, nombre, action) {
            console.log("Iniciando registro de historial para:", nombre, "con acción:", action);
            const url = `${GAS_REGISTER_HISTORY_URL}?action=registerHistory&cliente_id=${encodeURIComponent(cliente_id)}&nombre=${encodeURIComponent(nombre)}&event_action=${encodeURIComponent(action)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    console.log("Registro de historial exitoso:", data.message);
                } else {
                    console.error("Fallo al registrar historial:", data.message);
                }
            } catch (error) {
                console.error("Error al conectar para registrar historial:", error);
            }
        }
          
        // Función para generar un UUID corto de 5 caracteres alfanuméricos
        function generateShortUUID() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Función para formatear la fecha y hora a dd/mm/aaaa hh:mm:ss
        function formatDateTime(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Asignar un UUID al campo de Vehiculo ID al cargar la página
            document.getElementById('vehiculoId').value = generateShortUUID();

            // Definición de rutas para botones de navegación.
            // Nota: 'logoutBtn' no está incluido aquí, ya que su lógica es más compleja.
            const buttonRoutes = {
                'homeBtn': 'menu_app.html'
            };

            // Se utiliza 'Object.keys' para manejar la lógica de navegación simple.
            Object.keys(buttonRoutes).forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => {
                        window.location.href = buttonRoutes[id];
                    });
                }
            });

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.addEventListener('click', async () => {

                // Obtener el nombre de usuario de la sesión
                let userReg = '';
                const loggedInUser = sessionStorage.getItem('loggedInUser');
                if (loggedInUser) {
                    try {
                        const user = JSON.parse(loggedInUser);
                        userReg = user.Cliente_Nombre || 'Usuario Desconocido';
                    } catch (e) {
                        console.error('Error al analizar el JSON de usuario de la sesión:', e);
                    }
                }
                
                // 1. Recolectar los datos del formulario, incluyendo el nuevo campo UserReg
                const vehicleData = {
                    vehiculoId: document.getElementById('vehiculoId').value,
                    marca: document.getElementById('marca').value,
                    modelo: document.getElementById('modelo').value,
                    year: document.getElementById('year').value,
                    placa: document.getElementById('placa').value,
                    contacto: document.getElementById('contacto').value,
                    UserReg: userReg, // Nuevo campo del usuario de registro
                    DataReg: formatDateTime(new Date()),
                    Vehiculo_Estado: 'Activo'
                };

                // Comprobar si los campos requeridos están llenos antes de proceder
                if (!vehicleData.marca || !vehicleData.modelo || !vehicleData.year || !vehicleData.placa) {
                    showMessage('Por favor, rellena todos los campos obligatorios.');
                    return;
                }
                
                // Mostrar mensaje de "Cargando..." y deshabilitar el botón
                showMessage('Cargando...');
                saveBtn.disabled = true;

                // URL de tu script de Google Apps Script
                const GAS_REGISTER_VEH_URL = 'https://script.google.com/macros/s/AKfycbxEv68IX7TJ0CRAdGnrKAWd0cWh_R3VHNwztrzn2WlK52HL4_e6x-lmIg0-xvXFMxj6/exec';

                try {
                    const response = await fetch(GAS_REGISTER_VEH_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Para evitar errores de CORS en un entorno de prueba
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(vehicleData),
                    });

                    // Aunque "no-cors" no permite ver la respuesta, la petición se envía.
                    // Podemos asumir que si no hay un error de red, la petición fue enviada.
                    console.log('Petición enviada al servidor de Google Apps Script.');
                    
                    // Re-habilitar el botón y mostrar el mensaje de éxito en el modal
                    saveBtn.disabled = false;
                    showMessage('Registro exitoso realizado:', vehicleData);

                    // Restablece el formulario a sus valores iniciales
                    document.getElementById('vehicleForm').reset();
                    // Genera un nuevo UUID para el siguiente registro
                    document.getElementById('vehiculoId').value = generateShortUUID();

                } catch (error) {
                    console.error('Error al enviar los datos:', error);
                    saveBtn.disabled = false;
                    showMessage('Ocurrió un error al intentar registrar el vehículo. Por favor, inténtalo de nuevo.');
                }
                
            });

            // --- LÓGICA PARA EL REGISTRO DE HISTORIAL DE VISITA ---
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

            if (loggedInUser && loggedInUser.Cliente_ID && loggedInUser.Cliente_Nombre) {
                // Registrar la visita a esta página
            //    registerHistory(loggedInUser.Cliente_ID, loggedInUser.Cliente_Nombre, 'Visita a Menú');
            } else {
                console.warn("No hay usuario logueado. Redirigiendo a la página de inicio.");
                window.location.href = 'index.html';
            }            

            // --- Lógica del botón de salida ---
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    // Obtenemos los datos del usuario logueado desde sessionStorage
                    const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

                    // Verificamos que los datos del usuario existan antes de registrarlos.
                    if (loggedInUser && loggedInUser.Cliente_ID && loggedInUser.Cliente_Nombre) {
                        // Esperamos a que el registro de salida se complete.
                        // Esta función `registerHistory` debe estar definida en tu código.
                        registerHistory(loggedInUser.Cliente_ID, loggedInUser.Cliente_Nombre, 'Salida de la App');
                    }

                    // Limpiamos los datos del usuario de sessionStorage.
                    // Esto es crucial para que la sesión se cierre correctamente.
                    sessionStorage.removeItem('loggedInUser');

                    // Finalmente, redirigimos al usuario a la página de inicio.
                    window.location.href = 'index.html';
                });
            }            

            /**
             * Muestra un mensaje personalizado en el cuadro de diálogo con animaciones.
             * @param {string} message - El texto que se mostrará en el cuadro de mensaje.
             * @param {object} data - (Opcional) Objeto con los datos a mostrar.
             */
            function showMessage(message, data = null) {
                const messageBox = document.getElementById('messageBox');
                const messageText = document.getElementById('messageText');
                const dataList = document.getElementById('dataList');
                const modalContent = messageBox.querySelector('div');

                messageText.innerText = message;
                
                if (data) {
                    dataList.innerHTML = '';
                    // Se crea un objeto de mapeo para traducir las claves a etiquetas personalizadas
                    const labelMap = {
                        'vehiculoId': 'Vehículo ID',
                        'year': 'Año',
                        'Vehiculo_Estado': 'Condición'
                    };
                    for (const key in data) {
                        // Se verifica si la clave existe en el mapeo; de lo contrario, se usa el nombre original capitalizado
                        const label = labelMap[key] || key.charAt(0).toUpperCase() + key.slice(1);
                        const li = document.createElement('div');
                        li.innerHTML = `<strong class="font-bold">${label}:</strong> ${data[key]}`;
                        dataList.appendChild(li);
                    }
                } else {
                    dataList.innerHTML = '';
                }

                messageBox.classList.remove('hidden');

                void messageBox.offsetWidth;

                messageBox.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }

            window.closeMessage = function() {
                const messageBox = document.getElementById('messageBox');
                const modalContent = messageBox.querySelector('div');
                
                messageBox.classList.add('opacity-0');
                modalContent.classList.add('scale-95');

                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            };

        });
    </script>
</body>
</html>
